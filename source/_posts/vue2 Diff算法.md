---
title: vue2 diff算法
date: 2022-05-2 18:05:13
tags:
    - vue2
    - 源码
categories: 学习
---
## 虚拟节点与真实节点比对

为什么需要diff算法。

组件更新的时候，每次重新创建和替换真实Dom，会浪费性能。

这时候要尽可能复用，不多生成真实节点。比较两个虚拟dom，通过比较，patch需要修改的节点。

# diff算法

平级比较！一层一层的对应比较，父节点与父节点比较。如果第一层改变，则直接替换。

节点不一致，直接替换。

节点一致，比对属性，判断有没有key，如果是节点判断tag是否一致。父节点比较完成。

如果是文本，对比之后覆盖或不做操作。

如果是style，直接比对循环比对元素。

父节点比对完成，比对子节点。如果新的父节点有子节点，旧的没有，直接把虚拟子节点转换成真实节点，插入父节点。

如果新的没有，旧的有，直接删除。

如果旧的有子节点，新的也有子节点。

子节点优化：（1）头头尾尾比对
通过双指针，来比较数组常用操作，如：push, pop。
记住旧的头尾与新的头尾，循环对应比较，子节点的子节点也要递归。
双方有一个头尾指针，对比一次指针向后或者向前移动，头指针超过尾指针的，停止比较。
新的节点多的部分，直接创建真实dom插入。
如果结束时，少，则多余的删除。

（2）交叉比对
尾尾，头头比对不对，头尾交叉比对。
交叉比对上了，直接把旧的移动元素到新位置，指针移动，继续（1）（2）流程。


动态列表为什么需要key。

经过上面的比对，如果是一个动态列表，如果没有key，或者索引是index，动态列表更新的时候，key都是一致的。索引前后都是从0开始，就会认为头头是一致的，比对直接从头开始复用覆盖！


（3）乱序

新的直接一个个循环去父节点上面比对，比对和上面指针一样！找到了就复用，找不到就新增，多余的就删除！
